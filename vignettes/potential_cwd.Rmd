---
title: "Potential cumulative water deficit"
author: "Beni Stocker"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Potential CWD}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(readr)
library(dplyr)
library(here)
library(lubridate)
library(patchwork)
library(extRemes)
library(ggplot2)
library(cwd)
```

A potential cumulative water deficit can be calculated using net radiation and the *potential* evapotranspiration (PET). Here, we calculate PET based on net radiation and the approach by Priestley & Taylor (1972) as implemented by Davis et al. (2017). Necessary functions are part of the {cwd} package.

## Prepare data

Read data from the example FLUNXET file contained in this repository.
```{r}
df <- readRDS(file = paste0(here(), "/data/df_fr-pue.rds"))
```

## Apply PET function

... and convert from units of mm s-1 to mm d-1.
```{r}
# tested: identical results are obtained with:
# bigleaf::potential.ET(Tair = TA_F_MDS, pressure = PA_F*1e-3, Rn = NETRAD, approach = "Priestley-Taylor")$ET_pot * 30 * 30 * 24
df <- df |> 
  mutate(pet = 30 * 30 * 24 * pet(NETRAD, TA_F_MDS, PA_F))
```

## Visualise, contrasting to observed ET after conversion of energy to mass units

Convert latent heat flux (W/m2) to evapotranspiration in mass units (mm/d).
```{r}
# tested: identical results are obtained with:
# bigleaf::LE.to.ET(LE_F_MDS, TA_F_MDS)* 30 * 30 * 24
le_to_et <- function(le, tc, patm){
  1000 * 30 * 30 * 24 * le / (cwd::calc_enthalpy_vap(tc) * cwd::calc_density_h2o(tc, patm))
}

df <- df |>
  mutate(et = le_to_et(LE_F_MDS, TA_F_MDS, PA_F))
```

Plot mean seasonal cycle.
```{r}
df |> 
  mutate(doy = lubridate::yday(TIMESTAMP)) |> 
  group_by(doy) |> 
  summarise(
    et = mean(et),
    pet = mean(pet)
  ) |> 
  ggplot() +
  geom_line(aes(doy, et, color = "ET")) +
  geom_line(aes(doy, pet, color = "PET"))

```

## References

Davis, T. W., Prentice, I. C., Stocker, B. D., Thomas, R. T., Whitley, R. J., Wang, H., Evans, B. J., Gallego-Sala, A. V., Sykes, M. T., & Cramer, W. (2017). Simple process-led algorithms for simulating habitats (SPLASH v.1.0): Robust indices of radiation, evapotranspiration and plant-available moisture. Geoscientific Model Development, 10(2), 689–708. https://doi.org/10.5194/gmd-10-689-2017

Priestley, C. H. B., & Taylor, R. J. (1972). On the Assessment of Surface Heat Flux and Evaporation Using Large-Scale Parameters. Monthly Weather Review, 100(2), 81–92. https://doi.org/10.1175/1520-0493(1972)100<0081:OTAOSH>2.3.CO;2


